---
title: "Introduction to Wrangling and Visualization Part I"
output: html_notebook
---


# Introduction 

Data rarely comes perfectly prepared for the visualizations and analyses that you want to use to answer the questions you are most interested in. Thus, it is often the case that you may need to "wrangle" the data into a format or structure more amenable to the data science tasks you ultimately want to carry out.  In fact, it is not uncommon for a data scientist to spend significantly more time on wrangling data than on the data analysis.  Even in cases when the data is "clean" it still may useful to manipulate the data in various ways.  

Some common data wrangling tasks include:

1) Dealing with missing values
2) Arranging values in a column or columns in some way
3) Adding additional columns
4) Removing columns or rows
5) Aggregating parts of the data by a class or classes
6) Spreading data in a column across multiple rows
7) Combining information that is spread across multiple datasets

Displaying data as a graph, chart, or other visual object is an extremely powerful way to learn about the structure and basic properties of your data. Visual displays are also a highly effective way to communicate the results of your data analyses to other people. Visualization is also a major component of data exploration, the art of looking at your data, rapidly generating hypotheses, quickly testing them, then repeating again and again and again. The goal of data exploration is to generate many promising leads that you can later explore in more depth.   

In this notebook, we will begin to examine some of the basic principle of data wrangling and data visualization using the [dplyr](https://dplyr.tidyverse.org/) and [ggplot2](https://ggplot2.tidyverse.org/) R packages which are both part of the tidyverse family of packages. 

We will begin by loading these packages, make sure that they are installed on you computer or instance of R Studio. 

```{r,warning=FALSE,message=FALSE}
library(dplyr)
library(ggplot2)
```


# Introduction to ggplot2

Some data visualizations are better than others. The ggplot2 package encourages (enforces?) good visualization practices by implementing a "grammar of graphics" that, once mastered, allows one to quickly construct effective, clean, and high quality graphical presentations of data. Our goal here is to quickly develop a feel for ggplot2 and learn some useful techniques. Later we will consider deeper aspects of data visualization and more of the ggplot2 functionality as well as some extensions of ggplot2. 

## The ggplot function

The mot basic function in the ggplot2 package is the ggplot function. Let's take a look at it's documentation:
```{r}
?ggplot
```

It is important to understand that this function doesn't really create a plot so much as it creates a "canvas" to which "layers" can be added eventually producing a (possibly highly complex) data visualization. For example, one may add a **geom** of a specific type (e.g. point, line, bar, etc.) to produce a ceratin type of plot.  Pay attention to the three common ways that ggplot is invoked as described in the help page. Note that one will often input a data frame as the first argument to ggplot().  We will see examples soon.   

## What do you want to plot?

The structure of your data should be an import factor in determining what type(s) of plot you produce. Two initial questions that need to be addressed are

1) Are you interested in the distribution or other characteristics of a single variable?

2) Are you interested in the relation (if any) between multiple variables? 

If your answer to 1) is yes, then is the variable of interest quantitative, categorical, etc. and if it is quantitative, is it continuous or discrete? 

A similar question is relevant if the answer to 2) is yes but now the situation may be a little more complicated becuase you could have a mixture of categorical and quantitative, etc. variables. 

You may also need to transform your data in some manner (e.g. rescale) or take into account a spatial or other structure  in order to get the most effective visualization.

Rather than considering here all of the possibilities that may arise in regard to creating visualizations, we will proceed with a series of examples that can then be modifed or built upon in other ways in the future. 

## Working with single variable plots

### Histograms

A [histogram](https://en.wikipedia.org/wiki/Histogram) is a graphical representation of the distribution of (continuous) numerical data. Let's use the gapminder dataset for an initial example. 
```{r}
library(gapminder)
```

```{r}
head(gapminder)
```

**Question:** Which variable(s) from gapminder correspond to continuous numerical data? 

Here is a histogram of the gdpPercap variable:
```{r}
ggplot(data=gapminder,mapping=aes(x=gdpPercap)) + geom_histogram()
```
Notice that axes are automatically given labels. 

There are two points to mention. 

1) A histogram "bins" the data and you must make a choice for either the width of or number of bins. For example, here is the effect of changing the number of bins (the default number is 30):
```{r}
ggplot(data=gapminder,mapping=aes(x=gdpPercap)) + geom_histogram(bins=20)
```



2) There is more than one way to use ggplot functions to achieve the same result. For example, 

```{r}
ggplot(data=gapminder) + geom_histogram(mapping=aes(x=gdpPercap))
```

**Exercise** Use ggplot to create a histogram for the lifeExp variable in gapminder. Play around with the number of bins (or width of bins). 


Each geom function in ggplot2 takes a **mapping** argument. This defines how variables in your dataset are mapped to visual properties, e.g. to the coordinate axes. The mapping argument is always paired with **aes** that specifies how the variables in the data get associated with the **aesthetics** of the plot. 

You can also add **facets** which allow you to split your plot into subplots that each display one subset of the data according to classes determined by an additional categorical variable. For example, 
```{r}
ggplot(data=gapminder) + geom_histogram(mapping=aes(x=gdpPercap)) + 
  facet_wrap(~continent)
```

Here is another example of adding additional layers to a plot:
```{r}
ggplot(gapminder,aes(x=lifeExp)) + geom_histogram() + geom_rug()
```

Occassionally we are more interested in displaying the density of values rather than their counts as is the default behavior in a histogram. In order to obtain this, we must specify that a density stat is to be used instead of a count. For example,
```{r}
ggplot(gapminder,aes(x=lifeExp)) + geom_histogram(aes(y=..density..))
```

In this case, it is possible to overlay a probability density estimation:
```{r}
ggplot(gapminder,aes(x=lifeExp)) + geom_histogram(aes(y=..density..)) + 
  geom_density()
```

Let's take a second to understand this plot. We will simulate some data in order to do this. The following code samples 1500 values from a normal (Gaussian) distribution with mean 0 and standard deviation 1
```{r}
samp_data <- data.frame(x=rnorm(1500,0,1))
```

Let's plot it's (density) histogram:
```{r}
ggplot(samp_data,aes(x=x)) + geom_histogram(aes(y=..density..),binwidth=0.25)
```

Let's overlay a plot of the normal density function on the histogram:
```{r}
ggplot(samp_data,aes(x=x)) + geom_histogram(aes(y=..density..),binwidth=0.25) + stat_function(fun=dnorm,args=list(mean=0,sd=1))
```

Next, let's compare the density estimation with the plot of the (known) density function:
```{r}
ggplot(samp_data,aes(x=x)) + geom_histogram(aes(y=..density..),binwidth=0.25) +
  geom_density() + 
  stat_function(fun=dnorm,args=list(mean=0,sd=1))
```

### Boxplots

A boxplot is another way to visualize a single numerical variable. For example
```{r}
ggplot(gapminder,aes(y=lifeExp)) + geom_boxplot()
```

**Question:** What does a boxplot display? 

**Exercise:** Use "faceting" to display subsets of lifeExp using the continent variable to determine the subsets. 

We can also use a categorical variable such as continent to plot boxplots across categories by assigning to the x-axis the category values. For example,
```{r}
ggplot(gapminder,aes(x=continent,y=lifeExp)) + geom_boxplot()
```

In some sense this displays a relationship between the (continuous numeric) variable lifeExp and the (categorical) variable continent. You can add additional aesthetics to bring out some features of the plot. 

```{r}
ggplot(gapminder,aes(x=continent,y=lifeExp)) + geom_boxplot(aes(color=continent))
```
Notice that a legend was added automatically.

We can customize the color choices and the axis labels:
```{r}
library(RColorBrewer)
ggplot(gapminder,aes(x=continent,y=lifeExp)) + 
  geom_boxplot(aes(color=continent)) +
  scale_color_brewer(palette="YlOrRd") + 
  labs(x="Continent",y="Life Expectancy (in years)")
```


**Note:** Almost every aspect of a ggplot is fully customizable. We will see some of this as we move forward. 

The following plot shows the summary statistics min, max, and median for the lifeExp variable computed by continent. 
```{r}
ggplot(data = gapminder) + 
  stat_summary(
    mapping = aes(x = continent, y = lifeExp),
    fun.ymin = min,
    fun.ymax = max,
    fun.y = median
  )
```

**Exercise:** Create a similar plot for the gdpPercap variable. 

### Bar plots

A common method for visualizing the distribution of a single categorical variable is to use a boxplot. For example

```{r}
ggplot(gapminder,aes(x=continent)) + geom_bar()
```


**Exercise:** Explain the graph that results from the following command:
```{r}
ggplot(gapminder,aes(x=continent,fill=country)) + geom_bar() + 
  theme(legend.position = "none")
```

ggplot makes it very easy to add a title, caption, etc. For example, 
```{r}
ggplot(gapminder,aes(x=continent,fill=country)) + geom_bar() + 
  theme(legend.position = "none") + 
  labs(x="Continent",y="Count",title="Gapminder continents",subtitle="Data from https://www.gapminder.org/",caption="Colors distinguish countries of each continent")
```


It is also possible to display proportions with a bar plot. For example, 
```{r}
ggplot(data=gapminder) + geom_bar(mapping=aes(x=continent,y=..prop..,group=1))
```

**Exercise:** Explain the meaning of this plot. 

## Working with multiple variable plots

The gapminder dataset has 6 columns:
```{r}
dim(gapminder)
```

This implies that the gapminder dataset has six variables. We can see that two of those variables are categorical (country and continent) and the other four are numeric although we may question rather year should really be interpreted as a numeric variable. The question we shoudl consider is, how can we visualize more than one of these variables simultaneously in order to explore how these variables interact? 

### Scatter plots

For two continuous numeric variables, a scatter plot is a common approach to displaying the **covariantion** of the variables. For example,
```{r}
ggplot(gapminder,aes(x=gdpPercap,y=lifeExp)) + geom_point()
```

Notice that many of the points lie nearly on top of one another. In such cases it may be helpful to vary the translucence as for example in the following
```{r}
ggplot(gapminder,aes(x=gdpPercap,y=lifeExp)) + geom_point(alpha=0.2)
```

We can again add aesthetics to display additional variables. For example,
```{r}
ggplot(gapminder,aes(x=gdpPercap,y=lifeExp,size=pop)) + geom_point(alpha=0.2)
```

or even 
```{r}
ggplot(gapminder,aes(x=gdpPercap,y=lifeExp,size=pop,color=continent)) + geom_point(alpha=0.2)
```

Of course faceting will work here as well:
```{r}
ggplot(gapminder,aes(x=gdpPercap,y=lifeExp,size=pop)) + geom_point(alpha=0.2) + 
  facet_wrap(~continent)
```

In some cases, you might want to change the scale of the numeric values in some way that makes it easier to see what is happening. Consider for example the following:
```{r}
ggplot(gapminder,aes(x=log10(gdpPercap),y=lifeExp,size=pop)) + geom_point(alpha=0.2) + 
  facet_wrap(~continent)
```


Later we will discuss several extensions of ggplot but as a short example, we show  one such extension that provides a quick way to get a pairwise look at the covariation in the contiuous numerical variables in gapminder:
```{r}
library(GGally)
```

```{r}
ggpairs(gapminder[,4:6])
```

**Exercise:** Explain what this graph shows. 

### Categorical covariation 

If you want to visualize how a continuous variable interacts with a categorical variable, one approach is to use a histogram together with faceting. For example, 
```{r}
ggplot(gapminder) + geom_histogram(aes(x=lifeExp)) + facet_wrap(~continent)
```

These can be overlayed, but the result will not be clear. 
```{r}
ggplot(gapminder) + geom_histogram(aes(x=lifeExp,fill=continent))
```

A better result is obtained as follows:
```{r}
ggplot(gapminder) + geom_freqpoly(aes(x=lifeExp,color=continent))
```

What if you want to visualize how two categorical variables interact? 

One approach is to create a lattice of counts. For example, 
```{r}
ggplot(data = diamonds) +
  geom_count(mapping = aes(x = cut, y = color))
```

This example uses the diamonds dataset contained in the ggplot2 package. 

Another approach is to use tiles. For example, 
```{r}
diamonds %>% 
  count(color, cut) %>%  
  ggplot(mapping = aes(x = color, y = cut)) +
    geom_tile(mapping = aes(fill = n))
```

In this example, we have used "piping" and the count() function. These are part of the dplyr package which is the primary tidyverse package for data wrangling. This is the subject we take up next. 
```{r}
?count
```

